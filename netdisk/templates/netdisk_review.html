{% extends "netdisk_base.html" %}

{% block netdisk_content %}
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <div id="app">
        <p>查看重复的上传文件请去<a href="/admin/">admin面板</a>里看</p>
        <el-table :data="tableData">
            <el-table-column fixed prop="name" label="名称" width="350"></el-table-column>
            <el-table-column prop="size" label="大小" width="120"></el-table-column>
            <el-table-column prop="time" label="时间" width="150"></el-table-column>
            <el-table-column prop="user_id" label="用户ID" width="120"></el-table-column>
            <el-table-column fixed="right" label="操作" width="180">
                <template #default="scope">
                    <el-button @click="jumpToDownload(scope.row)" type="text" size="small">
                        下载
                    </el-button>
                    <el-button @click="acceptFile(scope.row)" type="text" size="small">
                        通过
                    </el-button>
                    <el-button @click="rejectFile(scope.row)" type="text" size="small">
                        拒绝
                    </el-button>
                </template>
            </el-table-column>
        </el-table>
    </div>
    <script>
        function sizeTostr(size) {
            var data = "";
            if (size < 0.1 * 1024) { //如果小于0.1KB转化成B
                data = size.toFixed(2) + "B";
            } else if (size < 0.1 * 1024 * 1024) {//如果小于0.1MB转化成KB
                data = (size / 1024).toFixed(2) + "KB";
            } else if (size < 0.1 * 1024 * 1024 * 1024) { //如果小于0.1GB转化成MB
                data = (size / (1024 * 1024)).toFixed(2) + "MB";
            } else { //其他转化成GB
                data = (size / (1024 * 1024 * 1024)).toFixed(2) + "GB";
            }
            var sizestr = data + "";
            var len = sizestr.indexOf("\.");
            var dec = sizestr.substr(len + 1, 2);
            if (dec == "00") {//当小数点后为00时 去掉小数部分
                return sizestr.substring(0, len) + sizestr.substr(len + 3, 2);
            }
            return sizestr;
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrfToken = getCookie('csrftoken');

        const netdisk_review = {
            data() {
                return {
                    rawData: {{ data | safe }}
                }
            },
            methods: {
                acceptFile: function (row) {
                    {#TODO: 增加对未以/结尾的鲁棒性#}
                    this.$prompt("请输入需要上传到的路径（以/结尾）", "提示", {
                        confirmButtonText: '提交',
                        cancelButtonText: '取消',
                    }).then(function (path) {
                        axios.post("/netdisk/admin/",
                            {
                                hash: row.hash,
                                role: "accept",
                                path: path.value
                            },
                            {
                                headers: {
                                    "X-CSRFToken":
                                    csrfToken
                                }
                            }
                        ).then(function () {
                                ElementPlus.ElMessage.success({
                                    message: '通过' + row.name + '成功',
                                    type: 'success',
                                    showClose: true,
                                })
                            }
                        ).catch(function (e) {
                            console.log(e)
                            ElementPlus.ElMessage.warning({
                                message: '通过' + row.name + "时出现错误，请重试",
                                type: 'warning',
                                showClose: true,
                            })
                        })
                    })
                },
                rejectFile: function (row) {
                    axios.post("/netdisk/admin/",
                        {
                            hash: row.hash,
                            role: "reject",
                        },
                        {
                            headers: {
                                "X-CSRFToken":
                                csrfToken
                            }
                        }
                    ).then(function () {
                            ElementPlus.ElMessage.success({
                                message: '拒绝' + row.name + '成功',
                                type: 'success',
                                showClose: true,
                            })
                        }
                    ).catch(function (e) {
                        console.log(e)
                        ElementPlus.ElMessage.warning({
                            message: '拒绝' + row.name + "时出现错误，请重试",
                            type: 'warning',
                            showClose: true,
                        })
                    })
                },
                jumpToDownload(row) {
                    let url = "/netdisk/admin/?file=" + row.name
                    window.open(url);
                }
            },
            computed: {
                tableData() {
                    let result = []
                    for (let file of this.rawData) {
                        file.fields.size = sizeTostr(file.fields.size)
                        result.push(file.fields)
                    }
                    return result
                }
            }
        }
        let app = Vue.createApp(netdisk_review);
        app.use(ElementPlus);
        app.mount('#app')
    </script>
{% endblock %}